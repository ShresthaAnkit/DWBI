DROP DATABASE OLTP_ANKIT;
DROP DATABASE OLAP_ANKIT_STG;
DROP DATABASE OLAP_ANKIT_TEMP;
DROP DATABASE OLAP_ANKIT_TGT;

CREATE DATABASE OLTP_ANKIT;

CREATE TABLE OLTP_ANKIT.CATEGORY (
	ID INT NOT NULL,
	CATEGORY_DESC VARCHAR(1024),
	primary key (ID)
);
CREATE  TABLE OLTP_ANKIT.COUNTRY (
	ID INT NOT NULL,
	COUNTRY_DESC VARCHAR(256),
	primary key (ID)
);
CREATE  TABLE OLTP_ANKIT.CUSTOMER (
	ID INT NOT NULL,
	CUSTOMER_FIRST_NAME VARCHAR(256),
	CUSTOMER_MIDDLE_NAME VARCHAR(256),
	CUSTOMER_LAST_NAME VARCHAR(256),
	CUSTOMER_ADDRESS VARCHAR(256),
	primary key (ID)
);
CREATE  TABLE OLTP_ANKIT.SUBCATEGORY (
	ID INT NOT NULL,
	CATEGORY_ID INT,
	SUBCATEGORY_DESC VARCHAR(256),
	primary key (ID),
	foreign key (CATEGORY_ID) references OLTP_ANKIT.CATEGORY(ID)
);
CREATE  TABLE OLTP_ANKIT.PRODUCT (
	ID INT NOT NULL,
	SUBCATEGORY_ID INT,
	PRODUCT_DESC VARCHAR(256),
	primary key (ID),
	foreign key (SUBCATEGORY_ID) references OLTP_ANKIT.SUBCATEGORY(ID)
);
CREATE  TABLE OLTP_ANKIT.REGION (
	ID INT NOT NULL,
	COUNTRY_ID INT,
	REGION_DESC VARCHAR(256),
	primary key (ID),
	foreign key (COUNTRY_ID) references OLTP_ANKIT.COUNTRY(ID)
);
CREATE  TABLE OLTP_ANKIT.STORE (
	ID INT NOT NULL,
	REGION_ID INT,
	STORE_DESC VARCHAR(256),
	primary key (ID),
	foreign key (REGION_ID) references OLTP_ANKIT.REGION(ID)
);

CREATE  TABLE OLTP_ANKIT.SALES (
	ID INT NOT NULL,
	STORE_ID INT NOT NULL,
	PRODUCT_ID INT NOT NULL,
	CUSTOMER_ID INT,
	TRANSACTION_TIME TIMESTAMP,
	QUANTITY INT,
	AMOUNT INT,
	DISCOUNT INT,
	primary key (ID),
	foreign key (STORE_ID) references OLTP_ANKIT.STORE(ID),
	foreign key (PRODUCT_ID) references OLTP_ANKIT.PRODUCT(ID),
	foreign key (CUSTOMER_ID) references OLTP_ANKIT.CUSTOMER(ID)
);

INSERT INTO OLTP_ANKIT.COUNTRY VALUES
(1, 'Nepal'),
(2, 'India');

#Insert into Region
INSERT INTO OLTP_ANKIT.REGION VALUES
(1, 1, 'Kathmandu'),
(2, 1, 'Lalitpur'),
(3, 2, 'Punjab'),
(4, 2, 'Bangalore');

#insert into Store
INSERT INTO OLTP_ANKIT.STORE VALUES
(1, 1, 'RETAIL Chakrapath'),
(2, 2, 'RETAIL Pulchowk'),
(3, 3, 'RETAIL Chandigarh'),
(4, 4, 'RETAIL Jayanagar');

#Insert into Categories
INSERT INTO OLTP_ANKIT.CATEGORY VALUES
(1,'Garment'),
(2,'GROCERY'),
(3,'KitchenWares');

#Insert into SubCategories
Insert into OLTP_ANKIT.SUBCATEGORY values
(1, 1,'MENS WEAR'),
(2, 1,'WOMENS WEAR'),
(3,1,'KIDS WEAR'),
(4,2,'Dairy'),
(5,2,'Fruits'), 
(6,2,'Packed Items'),
(7,3,'Utensils') ,
(8,3,'Glassware'),
(9,3,'ElectricAppliances');


#Insert into Product
insert into OLTP_ANKIT.PRODUCT values
(1,1,'Jeans'),
(2,2,'Shirt'),
(3,1,'Shoes'),
(4,5,'Apple'),
(5,5,'Oranges'),
(6,4,'Milk'),
(7,4,'Butter'),
(8,9, 'Microwave'),
(9,9, 'Coffee Maker'),
(10,7, 'Plate'),
(11,6,'Wai Wai'),
(12,6,'Oats'),
(13,3,'Diaper'),
(14,8,'Glass'),
(15,8,'Jug'),
(16,2,'Skirt'),
(17,7,'Spoon'),
(18,3,'Kids Jacket');

#Insert into Customer
insert into OLTP_ANKIT.CUSTOMER values
(1,'Ram',null,'Adhikari','Kathmandu'),
(2,'Shyam','Prasad','Sharma','lalitpur'),
(3,'Hari',null,'Poudel','Bhaktapur'),
(4, 'Saurav','Muhammed', 'Ali','Banglore'),
(5,'Kannur','Lokesh','Rahul','Punjab'),
(6, 'James',null,'Singh','Chennai');

CREATE DATABASE OLAP_ANKIT_STG;

CREATE TABLE OLAP_ANKIT_STG.CATEGORY (
	ID INT NOT NULL,
	CATEGORY_DESC VARCHAR(1024),
	primary key (ID)
);
CREATE  TABLE OLAP_ANKIT_STG.COUNTRY (
	ID INT NOT NULL,
	COUNTRY_DESC VARCHAR(256),
	primary key (ID)
);
CREATE  TABLE OLAP_ANKIT_STG.CUSTOMER (
	ID INT NOT NULL,
	CUSTOMER_FIRST_NAME VARCHAR(256),
	CUSTOMER_MIDDLE_NAME VARCHAR(256),
	CUSTOMER_LAST_NAME VARCHAR(256),
	CUSTOMER_ADDRESS VARCHAR(256),
	primary key (ID)
);
CREATE  TABLE OLAP_ANKIT_STG.SUBCATEGORY (
	ID INT NOT NULL,
	CATEGORY_ID INT,
	SUBCATEGORY_DESC VARCHAR(256),
	primary key (ID),
	foreign key (CATEGORY_ID) references OLAP_ANKIT_STG.CATEGORY(ID)
);
CREATE  TABLE OLAP_ANKIT_STG.PRODUCT (
	ID INT NOT NULL,
	SUBCATEGORY_ID INT,
	PRODUCT_DESC VARCHAR(256),
	primary key (ID),
	foreign key (SUBCATEGORY_ID) references OLAP_ANKIT_STG.SUBCATEGORY(ID)
);

CREATE  TABLE OLAP_ANKIT_STG.REGION (
	ID INT NOT NULL,
	COUNTRY_ID INT,
	REGION_DESC VARCHAR(256),
	primary key (ID),
	foreign key (COUNTRY_ID) references OLAP_ANKIT_STG.COUNTRY(ID)
);
CREATE  TABLE OLAP_ANKIT_STG.STORE (
	ID INT NOT NULL,
	REGION_ID INT,
	STORE_DESC VARCHAR(256),
	primary key (ID),
	foreign key (REGION_ID) references OLAP_ANKIT_STG.REGION(ID)
);
CREATE  TABLE OLAP_ANKIT_STG.SALES (
	ID INT NOT NULL,
	STORE_ID INT NOT NULL,
	PRODUCT_ID INT NOT NULL,
	CUSTOMER_ID INT,
	TRANSACTION_TIME TIMESTAMP,
	QUANTITY INT,
	AMOUNT INT,
	DISCOUNT INT,
	primary key (ID),
	foreign key (STORE_ID) references OLAP_ANKIT_STG.STORE(ID),
	foreign key (PRODUCT_ID) references OLAP_ANKIT_STG.PRODUCT(ID),
	foreign key (CUSTOMER_ID) references OLAP_ANKIT_STG.CUSTOMER(ID)
);

CREATE DATABASE OLAP_ANKIT_TEMP;

CREATE TABLE OLAP_ANKIT_TEMP.CATEGORY (
	ID INT NOT NULL,
	CATEGORY_DESC VARCHAR(1024),
	primary key (ID)
);
CREATE  TABLE OLAP_ANKIT_TEMP.COUNTRY (
	ID INT NOT NULL,
	COUNTRY_DESC VARCHAR(256),
	primary key (ID)
);
CREATE  TABLE OLAP_ANKIT_TEMP.CUSTOMER (
	ID INT NOT NULL,
	CUSTOMER_FIRST_NAME VARCHAR(256),
	CUSTOMER_MIDDLE_NAME VARCHAR(256),
	CUSTOMER_LAST_NAME VARCHAR(256),
	CUSTOMER_ADDRESS VARCHAR(256),
	primary key (ID)
);
CREATE  TABLE OLAP_ANKIT_TEMP.SUBCATEGORY (
	ID INT NOT NULL,
	CATEGORY_ID INT,
	SUBCATEGORY_DESC VARCHAR(256),
	primary key (ID),
	foreign key (CATEGORY_ID) references OLAP_ANKIT_TEMP.CATEGORY(ID)
);
CREATE  TABLE OLAP_ANKIT_TEMP.PRODUCT (
	ID INT NOT NULL,
	SUBCATEGORY_ID INT,
	PRODUCT_DESC VARCHAR(256),
	primary key (ID),
	foreign key (SUBCATEGORY_ID) references OLAP_ANKIT_TEMP.SUBCATEGORY(ID)
);


CREATE  TABLE OLAP_ANKIT_TEMP.REGION (
	ID INT NOT NULL,
	COUNTRY_ID INT,
	REGION_DESC VARCHAR(256),
	primary key (ID),
	foreign key (COUNTRY_ID) references OLAP_ANKIT_TEMP.COUNTRY(ID)
);
CREATE  TABLE OLAP_ANKIT_TEMP.STORE (
	ID INT NOT NULL,
	REGION_ID INT,
	STORE_DESC VARCHAR(256),
	primary key (ID),
	foreign key (REGION_ID) references OLAP_ANKIT_TEMP.REGION(ID)
);
CREATE  TABLE OLAP_ANKIT_TEMP.SALES (
	ID INT NOT NULL,
	STORE_ID INT NOT NULL,
	PRODUCT_ID INT NOT NULL,
	CUSTOMER_ID INT,
	TRANSACTION_TIME TIMESTAMP,
	QUANTITY INT,
	AMOUNT INT,
	DISCOUNT INT,
	primary key (ID),
	foreign key (STORE_ID) references OLAP_ANKIT_TEMP.STORE(ID),
	foreign key (PRODUCT_ID) references OLAP_ANKIT_TEMP.PRODUCT(ID),
	foreign key (CUSTOMER_ID) references OLAP_ANKIT_TEMP.CUSTOMER(ID)
);

CREATE DATABASE OLAP_ANKIT_TGT;

CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_CNTRY_T (
  CNTRY_ID INT,
  CNTRY_KY INT NOT NULL auto_increment,
  CNTRY_DESC VARCHAR(50),
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint CNTRY_PK primary key (CNTRY_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_CTGRY_T (
  CTGRY_ID INT,
  CTGRY_KY INT NOT NULL auto_increment,
  CTGRY_DESC VARCHAR(50),
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint CTGRY_PK primary key (CTGRY_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_CUSTOMER_T (
  CUSTOMER_ID INT,
  CUSTOMER_KY INT NOT NULL auto_increment,
  CUSTOMER_FST_NM VARCHAR(20),
  CUSTOMER_MID_NM VARCHAR(20),
  CUSTOMER_LST_NM VARCHAR(20),
  CUSTOMER_ADDR VARCHAR(20),
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint CUSTOMER_PK primary key (CUSTOMER_KY)
);

CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_LOCN_T (
  LOCN_ID INT,
  LOCN_KY INT NOT NULL auto_increment,
  RGN_KY INT,
  CNTRY_KY INT,
  LOCN_DESC VARCHAR(50),
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint LOCN_PK primary key (LOCN_KY)
);

CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_PDT_T (
  PDT_ID INT,
  PDT_KY INT NOT NULL auto_increment,
  SUB_CTGRY_KY INT,  
  CTGRY_KY INT,
  PDT_DESC VARCHAR(50),
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint PDT_PK primary key (PDT_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_RGN_T (
  RGN_ID INT,
  RGN_KY INT NOT NULL auto_increment,
  CNTRY_KY INT,
  RGN_DESC VARCHAR(50),
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint RGN_PK primary key (RGN_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_SUB_CTGRY_T (
  SUB_CTGRY_ID INT,
  SUB_CTGRY_KY INT NOT NULL auto_increment,
  CTGRY_KY INT,
  SUB_CTGRY_DESC VARCHAR(50),
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint SUB_CTGRY_PK primary key (SUB_CTGRY_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.F_RETAIL_SLS_T (
  ROW_KEY INT NOT NULL auto_increment,
  SLS_ID INT NOT NULL,
  LOCN_KY INT,
  DT_KY INT,
  PDT_KY INT,
  CUSTOMER_KY INT,
  TRANSACTION_TIME TIMESTAMP,
  QTY INT,
  AMT INT,
  DSCNT INT,
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint SLS_PK primary key (ROW_KEY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_DAY_T (
  ID DATE NOT NULL,
  DT_KY DATE NOT NULL,
  MONTH_KY INT,
  QUARTER_KY INT NOT NULL,
  YEAR_KY INT NOT NULL,
  HALF_YEAR_KY INT NOT NULL,
  DAY_START_TIME TIME NOT NULL,
  DAY_END_TIME TIME NOT NULL,
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint DAY_PK primary key (DT_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_HALF_YEAR_T (
  ID INT NOT NULL,
  HALF_YEAR_KY INT NOT NULL,
  YEAR_KY INT NOT NULL,
  HALF_YEAR_START_DATE DATE NOT NULL,
  HALF_YEAR_END_DATE DATE NOT NULL,
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint HALF_YEAR_PK primary key (HALF_YEAR_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_HOUR_T (
  ID INT,
  HOUR_KY INT NOT NULL,
  constraint HOUR_PK primary key (HOUR_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_MIN_T (
  ID INT,
  MIN_KY INT NOT NULL,
  HOUR_KY INT,
  constraint MIN_PK primary key (MIN_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_MONTH_T (
  ID INT NOT NULL,
  MONTH_KY INT NOT NULL,
  MONTH_DESC INT NOT NULL,
  QUARTER_KY INT NOT NULL,
  YEAR_KY INT NOT NULL,
  HALF_YEAR_KY INT NOT NULL,
  MONTH_START_DATE DATE NOT NULL,
  MONTH_END_DATE DATE NOT NULL,
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint MONTH_PK primary key (MONTH_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_QUARTER_T (
  ID INT NOT NULL,
  QUARTER_KY INT NOT NULL,
  YEAR_KY INT NOT NULL,
  HALF_YEAR_KY INT NOT NULL,
  QUARTER_START_DATE DATE NOT NULL,
  QUARTER_END_DATE DATE NOT NULL,
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint QUARTER_PK primary key (QUARTER_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_SEC_T (
  ID INT,
  SEC_KY INT NOT NULL,
  MIN_KY INT,
  HOUR_KY INT,
  constraint SEC_PK primary key (SEC_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.D_RETAIL_TIME_YEAR_T (
  ID INT,
  YEAR_KY INT NOT NULL,
  YEAR_START_DATE DATE NOT NULL,
  YEAR_END_DATE DATE NOT NULL,
  ROW_INSRT_TMS TIME,
  ROW_UPDT_TMS TIME,
  constraint YEAR_PK primary key (YEAR_KY)
);
CREATE  TABLE OLAP_ANKIT_TGT.F_RETAIL_AGG_SLS_PLC_MONTH_T (
  ROW_KEY INT NOT NULL auto_increment,
  PDT_KY INT NOT NULL,
  LOCN_KY INT NOT NULL,
  MONTH_KY INT NOT NULL,
  TOTAL_QTY INT,
  TOTAL_AMT INT,
  TOTAL_DSCNT INT,
  ROW_INSRT_TMS TIME NOT NULL,
  ROW_UPDT_TMS TIME NOT NULL,
  constraint SLS_AGG_PK primary key (ROW_KEY)
);

CREATE  TABLE OLAP_ANKIT_TGT.F_RETAIL_FRCST_SLS_T (
  DT_KY DATE,
  SLS_AMT_FCST INT
);

SET SESSION cte_max_recursion_depth = 20000;
CREATE TABLE OLAP_ANKIT_TGT.DIM_CALENDAR AS
WITH RECURSIVE DateSeries AS (
    SELECT
        '2000-01-01' AS date
    UNION ALL
    SELECT
        DATE_ADD(date, INTERVAL 1 DAY)
    FROM
        DateSeries
    WHERE
        date < '2050-12-31'
)
SELECT
    date,
    DATE_FORMAT(date, '%Y%m%d') AS day_key,
    YEAR(date) AS year,
    MONTH(date) AS month,
    WEEK(date, 3) AS week,
    DAYOFWEEK(date) AS day_of_week,
    DAYOFYEAR(date) AS day_of_year,
    DAY(date) AS day_of_month,
    QUARTER(date) AS quarter,
    CASE
        WHEN DAYOFWEEK(date) IN (1, 7) THEN 1
        ELSE 0
    END AS is_weekend,
    0 AS is_holiday,
    MONTHNAME(date) AS month_name,
    DAYNAME(date) AS day_name,
    DATE_SUB(date, INTERVAL (DAYOFWEEK(date) - 2) DAY) AS week_start_date,
    DATE_ADD(date, INTERVAL (7 - DAYOFWEEK(date)) DAY) AS week_end_date,
    DATE_FORMAT(date, '%Y-%m-01') AS month_start_date,
    LAST_DAY(date) AS month_end_date,
    DATE_FORMAT(date, '%Y-01-01') AS year_start_date,
    DATE_FORMAT(date, '%Y-12-31') AS year_end_date
FROM
    DateSeries;
